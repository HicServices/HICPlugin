name: Build, test and package

on: push

env:
  MSSQL_SA_PASSWORD: "YourStrong!Passw0rd"
  ACCEPT_EULA: "Y"
  MSSQL_PID: "developer"
  
jobs:
  package:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: HicServices/RDMP
          ref: develop
          path: RDMP
      - uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 6.0.x
      - uses: chrisdickinson/setup-yq@latest
      - name: Get version
        id: version
        shell: cmd
        run: |
          getversions >> %GITHUB_OUTPUT%
          echo "PLUGIN_NAME=$(cat settings.yml | yq .nuspecFileName)" >> $GITHUB_OUTPUT
      - name: Set up database
        run: |
          dotnet run --project RDMP/Tools/rdmp/rdmp.csproj -c Release -- install localhost TEST_ -d
      - name: Test
        run: |
          dotnet test
      - name: Build
        run: |
          ./build_plugin.sh
      - name: Store created nupkg files
        uses: actions/upload-artifact@v3
        with:
          path: ./*.nupkg
          retention-days: 1
      - name: Upload release binaries
        if: contains(github.ref,'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: '${{steps.version.outputs.PLUGIN_NAME}}.${{ steps.version.outputs.version }}.nupkg'
        #   todo this needs the correct name
